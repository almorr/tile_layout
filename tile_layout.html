<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificateur de carrelage</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f0f0f0; }
        .lang-bar { background: #2196F3; color: white; padding: 15px 20px; }
        .lang-bar select { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .content { padding: 20px; }
        .section { margin-bottom: 15px; padding: 15px; background: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .walls-grid { display: flex; gap: 20px; margin-top: 20px; overflow-x: auto; padding: 10px; }
        .wall-item { flex-shrink: 0; }
        .wall-header { font-weight: bold; margin-bottom: 10px; padding: 8px; background: #4CAF50; color: white; border-radius: 5px; text-align: center; }
        canvas { border: 2px solid #333; cursor: grab; background: white; display: block; }
        canvas:active { cursor: grabbing; }
        button { padding: 8px 16px; margin: 5px 5px 5px 0; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px; font-size: 14px; }
        button:hover { background: #45a049; }
        input[type="number"], select { padding: 5px; border: 1px solid #ccc; border-radius: 3px; margin: 0 5px; }
        label { margin-right: 10px; font-size: 14px; }
        .item-list { margin-top: 10px; max-height: 150px; overflow-y: auto; }
        .item { padding: 5px; margin-top: 5px; background: #f9f9f9; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { padding: 3px 8px; background: #dc3545; font-size: 12px; margin: 0; }
        .wall-input { display: inline-block; margin: 5px 10px 5px 0; }
    </style>
</head>
<body>
    <div class="lang-bar">
        <strong id="t-lang">Langue</strong>:
        <select id="langSelect" onchange="switchLang()">
            <option value="fr" selected>Fran√ßais</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
        </select>
    </div>
    
    <div class="content">
        <div class="section">
            <strong id="t-walls">Murs</strong>: 
            <select id="numWalls" onchange="changeWallCount()">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
            <div id="wallInputs" style="margin-top: 10px;"></div>
        </div>
        
        <div class="section">
            <strong id="t-tile">Carrelage</strong>: 
            <label><span id="t-width">Largeur</span> (cm): <input type="number" id="tileW" value="60" style="width: 70px;"></label>
            <label><span id="t-height">Hauteur</span> (cm): <input type="number" id="tileH" value="60" style="width: 70px;"></label>
            <button onclick="applyAll()" id="t-apply">Appliquer</button>
        </div>
        
        <div class="section">
            <strong id="t-zones">Zones</strong>:
            <label><span id="t-wall">Mur</span>: <select id="zoneWall"></select></label>
            <label><span id="t-side">C√¥t√©</span>: <select id="zoneSide"><option value="left" id="t-left1">Gauche</option><option value="right" id="t-right1">Droite</option></select></label>
            <label><span id="t-width2">Largeur</span>: <input type="number" id="zoneW" value="90" style="width: 60px;"></label>
            <label><span id="t-height2">Hauteur</span>: <input type="number" id="zoneH" value="200" style="width: 60px;"></label>
            <label><span id="t-color">Couleur</span>: <select id="zoneColor">
                <option value="red" id="t-red">Rouge</option>
                <option value="green" id="t-green">Vert</option>
                <option value="blue" id="t-blue">Bleu</option>
                <option value="yellow" id="t-yellow">Jaune</option>
            </select></label>
            <button onclick="addZone()" style="background: #f44336;" id="t-add-zone">Ajouter</button>
            <div id="zoneList" class="item-list"></div>
        </div>
        
        <div class="section">
            <strong id="t-windows">Fen√™tres</strong>:
            <label><span id="t-wall2">Mur</span>: <select id="winWall"></select></label>
            <label><span id="t-dist-left">Distance depuis la gauche</span> (cm): <input type="number" id="winLeft" value="50" style="width: 70px;"></label>
            <label><span id="t-dist-bottom">Distance depuis le bas</span> (cm): <input type="number" id="winBottom" value="100" style="width: 70px;"></label>
            <label><span id="t-width3">Largeur</span> (cm): <input type="number" id="winW" value="100" style="width: 70px;"></label>
            <label><span id="t-height3">Hauteur</span> (cm): <input type="number" id="winH" value="120" style="width: 70px;"></label>
            <button onclick="addWin()" style="background: #2196F3;" id="t-add-win">Ajouter</button>
            <div id="winList" class="item-list"></div>
        </div>
        
        <div class="section">
            <strong id="t-taps">Robinets</strong>:
            <label><span id="t-wall3">Mur</span>: <select id="tapWall"></select></label>
            <label>X (cm): <input type="number" id="tapX" value="50" style="width: 60px;"></label>
            <label>Y (cm): <input type="number" id="tapY" value="100" style="width: 60px;"></label>
            <label>‚åÄ (cm): <input type="number" id="tapD" value="5" style="width: 50px;"></label>
            <button onclick="addTap()" style="background: #ff9800;" id="t-add-tap">Ajouter</button>
            <div id="tapList" class="item-list"></div>
        </div>
        
        <div class="section">
            <button onclick="resetAll()" id="t-reset">R√©initialiser la grille</button>
            <button onclick="saveData()" style="background: #9C27B0;" id="t-save">üíæ Enregistrer</button>
            <button onclick="document.getElementById('fileInput').click()" style="background: #FF5722;" id="t-load">üìÇ Charger</button>
            <input type="file" id="fileInput" accept=".json" style="display:none;" onchange="loadData(event)">
            <span id="offsetInfo"></span>
        </div>
        
        <div class="walls-grid" id="canvasContainer"></div>
    </div>

    <script>
        const SCALE = 2, GRID = 10;
        let lang = 'fr';
        let tileW = 60, tileH = 60, verticalOffset = 0;
        let walls = [{w:300,h:250,canvas:null,ctx:null,offsetX:0}];
        let zones = [], zoneCounter = 0;
        let windows = [], winCounter = 0;
        let taps = [], tapCounter = 0;
        let dragging = false, dragWall = -1, dragStartX = 0, dragStartY = 0;
        
        const T = {
            fr: {lang:'Langue',walls:'Murs',wall:'Mur',width:'Largeur',height:'Hauteur',tile:'Carrelage',apply:'Appliquer',zones:'Zones',side:'C√¥t√©',left:'Gauche',right:'Droite',color:'Couleur',red:'Rouge',green:'Vert',blue:'Bleu',yellow:'Jaune',addZone:'Ajouter',windows:'Fen√™tres',distLeft:'Distance depuis la gauche',distBottom:'Distance depuis le bas',addWin:'Ajouter',taps:'Robinets',addTap:'Ajouter',reset:'R√©initialiser la grille',save:'Enregistrer',load:'Charger',offset:'D√©calage',del:'√ó',none:'Aucun'},
            ru: {lang:'–Ø–∑—ã–∫',walls:'–°—Ç–µ–Ω—ã',wall:'–°—Ç–µ–Ω–∞',width:'–®–∏—Ä–∏–Ω–∞',height:'–í—ã—Å–æ—Ç–∞',tile:'–ü–ª–∏—Ç–∫–∞',apply:'–ü—Ä–∏–º–µ–Ω–∏—Ç—å',zones:'–ó–æ–Ω—ã',side:'–°—Ç–æ—Ä–æ–Ω–∞',left:'–°–ª–µ–≤–∞',right:'–°–ø—Ä–∞–≤–∞',color:'–¶–≤–µ—Ç',red:'–ö—Ä–∞—Å–Ω—ã–π',green:'–ó–µ–ª–µ–Ω—ã–π',blue:'–°–∏–Ω–∏–π',yellow:'–ñ–µ–ª—Ç—ã–π',addZone:'–î–æ–±–∞–≤–∏—Ç—å',windows:'–û–∫–Ω–∞',distLeft:'–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–ª–µ–≤–∞',distBottom:'–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–Ω–∏–∑—É',addWin:'–î–æ–±–∞–≤–∏—Ç—å',taps:'–ö—Ä–∞–Ω—ã',addTap:'–î–æ–±–∞–≤–∏—Ç—å',reset:'–°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Ç–∫—É',save:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',load:'–ó–∞–≥—Ä—É–∑–∏—Ç—å',offset:'–°–º–µ—â–µ–Ω–∏–µ',del:'√ó',none:'–ù–µ—Ç'},
            en: {lang:'Language',walls:'Walls',wall:'Wall',width:'Width',height:'Height',tile:'Tile',apply:'Apply',zones:'Zones',side:'Side',left:'Left',right:'Right',color:'Color',red:'Red',green:'Green',blue:'Blue',yellow:'Yellow',addZone:'Add',windows:'Windows',distLeft:'Distance from left',distBottom:'Distance from bottom',addWin:'Add',taps:'Taps',addTap:'Add',reset:'Reset grid',save:'Save',load:'Load',offset:'Offset',del:'√ó',none:'None'}
        };
        
        function t(key) { return T[lang][key] || key; }
        function setTxt(id, txt) { const el = document.getElementById(id); if (el) el.textContent = txt; }
        
        function switchLang() {
            lang = document.getElementById('langSelect').value;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            setTxt('t-lang', t('lang'));
            setTxt('t-walls', t('walls'));
            setTxt('t-wall', t('wall'));
            setTxt('t-wall2', t('wall'));
            setTxt('t-wall3', t('wall'));
            setTxt('t-width', t('width'));
            setTxt('t-height', t('height'));
            setTxt('t-width2', t('width'));
            setTxt('t-height2', t('height'));
            setTxt('t-width3', t('width'));
            setTxt('t-height3', t('height'));
            setTxt('t-tile', t('tile'));
            setTxt('t-apply', t('apply'));
            setTxt('t-zones', t('zones'));
            setTxt('t-side', t('side'));
            setTxt('t-left1', t('left'));
            setTxt('t-right1', t('right'));
            setTxt('t-color', t('color'));
            setTxt('t-red', t('red'));
            setTxt('t-green', t('green'));
            setTxt('t-blue', t('blue'));
            setTxt('t-yellow', t('yellow'));
            setTxt('t-add-zone', t('addZone'));
            setTxt('t-windows', t('windows'));
            setTxt('t-dist-left', t('distLeft'));
            setTxt('t-dist-bottom', t('distBottom'));
            setTxt('t-add-win', t('addWin'));
            setTxt('t-taps', t('taps'));
            setTxt('t-add-tap', t('addTap'));
            setTxt('t-reset', t('reset'));
            setTxt('t-save', t('save'));
            setTxt('t-load', t('load'));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            updateWallInputs();
            refreshSelects();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–µ–Ω
            const headers = document.querySelectorAll('.wall-header');
            headers.forEach((header, i) => {
                if (walls[i]) {
                    header.textContent = `${t('wall')} ${i+1} (${walls[i].w}√ó${walls[i].h} cm)`;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
            updateZoneList();
            updateWinList();
            updateTapList();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–º–µ—â–µ–Ω–∏–∏
            document.getElementById('offsetInfo').textContent = `${t('offset')}: ‚Üï ${verticalOffset.toFixed(1)} cm`;
        }
        
        function changeWallCount() {
            const n = parseInt(document.getElementById('numWalls').value);
            while (walls.length < n) walls.push({w:250,h:246,canvas:null,ctx:null,offsetX:0});
            walls = walls.slice(0, n);
            updateWallInputs();
            refreshSelects();
            initCanvas();
        }
        
        function updateWallInputs() {
            let html = '';
            walls.forEach((wall, i) => {
                html += `<div class="wall-input"><strong>${t('wall')} ${i+1}:</strong> <label>${t('width')}: <input type="number" id="wallW${i}" value="${wall.w}" min="50" max="1000" style="width:65px;"></label> <label>${t('height')}: <input type="number" id="wallH${i}" value="${wall.h}" min="50" max="1000" style="width:65px;"></label></div>`;
            });
            document.getElementById('wallInputs').innerHTML = html;
        }
        
        function refreshSelects() {
            let opts = '';
            walls.forEach((w, i) => opts += `<option value="${i}">${i+1}</option>`);
            ['zoneWall', 'winWall', 'tapWall'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = opts;
            });
        }
        
        function initCanvas() {
            const container = document.getElementById('canvasContainer');
            container.innerHTML = '';
            walls.forEach((wall, i) => {
                const div = document.createElement('div');
                div.className = 'wall-item';
                const header = document.createElement('div');
                header.className = 'wall-header';
                header.textContent = `${t('wall')} ${i+1} (${wall.w}√ó${wall.h} cm)`;
                div.appendChild(header);
                
                const canvas = document.createElement('canvas');
                canvas.width = wall.w * SCALE;
                canvas.height = wall.h * SCALE;
                canvas.dataset.idx = i;
                wall.canvas = canvas;
                wall.ctx = canvas.getContext('2d');
                
                canvas.onmousedown = (e) => {
                    dragging = true;
                    dragWall = parseInt(e.target.dataset.idx);
                    const rect = e.target.getBoundingClientRect();
                    dragStartX = e.clientX - rect.left;
                    dragStartY = e.clientY - rect.top;
                };
                canvas.onmousemove = (e) => {
                    if (!dragging || dragWall !== i) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    walls[dragWall].offsetX += (x - dragStartX) / SCALE;
                    verticalOffset -= (y - dragStartY) / SCALE;
                    dragStartX = x;
                    dragStartY = y;
                    drawAll();
                };
                canvas.onmouseup = canvas.onmouseleave = () => { dragging = false; dragWall = -1; };
                
                div.appendChild(canvas);
                container.appendChild(div);
            });
            drawAll();
        }
        
        function drawWall(idx) {
            const wall = walls[idx];
            const ctx = wall.ctx;
            const canvas = wall.canvas;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 0.5;
            for (let x = 0; x <= wall.w; x += GRID) {
                ctx.beginPath();
                ctx.moveTo(x*SCALE, 0);
                ctx.lineTo(x*SCALE, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= wall.h; y += GRID) {
                const py = canvas.height - y*SCALE;
                ctx.beginPath();
                ctx.moveTo(0, py);
                ctx.lineTo(canvas.width, py);
                ctx.stroke();
            }
            
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 2;
            const sx = (wall.offsetX % tileW) - tileW;
            const sy = (verticalOffset % tileH) - tileH;
            for (let x = sx; x <= wall.w; x += tileW) {
                ctx.beginPath();
                ctx.moveTo(x*SCALE, 0);
                ctx.lineTo(x*SCALE, canvas.height);
                ctx.stroke();
            }
            for (let y = sy; y <= wall.h; y += tileH) {
                const py = canvas.height - y*SCALE;
                ctx.beginPath();
                ctx.moveTo(0, py);
                ctx.lineTo(canvas.width, py);
                ctx.stroke();
            }
            
            const colors = {red:'rgba(255,0,0,0.15)',green:'rgba(0,255,0,0.15)',blue:'rgba(0,0,255,0.15)',yellow:'rgba(255,255,0,0.25)'};
            const strokes = {red:'#f00',green:'#0f0',blue:'#00f',yellow:'#fc0'};
            zones.filter(z => z.wall === idx).forEach(z => {
                const zx = z.side === 'left' ? 0 : (wall.w - z.w) * SCALE;
                const zy = canvas.height - z.h * SCALE;
                ctx.fillStyle = colors[z.color];
                ctx.fillRect(zx, zy, z.w*SCALE, z.h*SCALE);
                ctx.strokeStyle = strokes[z.color];
                ctx.lineWidth = 3;
                ctx.strokeRect(zx, zy, z.w*SCALE, z.h*SCALE);
            });
            
            windows.filter(w => w.wall === idx).forEach(w => {
                const wx = w.left * SCALE;
                const wy = canvas.height - (w.bottom + w.h) * SCALE;
                ctx.fillStyle = 'rgba(135,206,250,0.3)';
                ctx.fillRect(wx, wy, w.w*SCALE, w.h*SCALE);
                ctx.strokeStyle = '#1976D2';
                ctx.lineWidth = 4;
                ctx.strokeRect(wx, wy, w.w*SCALE, w.h*SCALE);
                ctx.beginPath();
                ctx.moveTo(wx, wy);
                ctx.lineTo(wx+w.w*SCALE, wy+w.h*SCALE);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(wx+w.w*SCALE, wy);
                ctx.lineTo(wx, wy+w.h*SCALE);
                ctx.stroke();
            });
            
            taps.filter(t => t.wall === idx).forEach(tap => {
                const tx = tap.x * SCALE;
                const ty = canvas.height - tap.y * SCALE;
                const r = (tap.d / 2) * SCALE;
                ctx.strokeStyle = '#FF6B00';
                ctx.lineWidth = 3;
                const s = r + 5;
                ctx.beginPath();
                ctx.moveTo(tx-s, ty-s);
                ctx.lineTo(tx+s, ty+s);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(tx+s, ty-s);
                ctx.lineTo(tx-s, ty+s);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(tx, ty, r, 0, Math.PI*2);
                ctx.stroke();
                ctx.fillStyle = '#FF6B00';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(`‚åÄ${tap.d}`, tx+r+8, ty-5);
            });
        }
        
        function drawAll() {
            walls.forEach((w, i) => drawWall(i));
            document.getElementById('offsetInfo').textContent = `${t('offset')}: ‚Üï ${verticalOffset.toFixed(1)} cm`;
        }
        
        function applyAll() {
            walls.forEach((wall, i) => {
                const wEl = document.getElementById(`wallW${i}`);
                const hEl = document.getElementById(`wallH${i}`);
                if (wEl) {
                    const v = parseInt(wEl.value);
                    if (v >= 50 && v <= 1000) wall.w = v;
                }
                if (hEl) {
                    const v = parseInt(hEl.value);
                    if (v >= 50 && v <= 1000) wall.h = v;
                }
            });
            const tw = parseInt(document.getElementById('tileW').value);
            const th = parseInt(document.getElementById('tileH').value);
            if (tw >= 10 && tw <= 200) tileW = tw;
            if (th >= 10 && th <= 200) tileH = th;
            walls.forEach(w => w.offsetX = 0);
            verticalOffset = 0;
            initCanvas();
        }
        
        function resetAll() {
            walls.forEach(w => w.offsetX = 0);
            verticalOffset = 0;
            drawAll();
        }
        
        function addZone() {
            const wall = parseInt(document.getElementById('zoneWall').value);
            const side = document.getElementById('zoneSide').value;
            const w = parseInt(document.getElementById('zoneW').value);
            const h = parseInt(document.getElementById('zoneH').value);
            const color = document.getElementById('zoneColor').value;
            if (!w || !h) return;
            zones.push({id:zoneCounter++, wall, side, w, h, color});
            updateZoneList();
            drawAll();
        }
        
        function delZone(id) {
            zones = zones.filter(z => z.id !== id);
            updateZoneList();
            drawAll();
        }
        
        function updateZoneList() {
            const el = document.getElementById('zoneList');
            if (!zones.length) {
                el.innerHTML = `<div style="color:#666;font-style:italic;">${t('none')}</div>`;
                return;
            }
            const emoji = {red:'üî¥',green:'üü¢',blue:'üîµ',yellow:'üü°'};
            let html = '';
            zones.forEach(z => {
                const side = z.side === 'left' ? t('left') : t('right');
                html += `<div class="item"><span>${emoji[z.color]} ${t('wall')} ${z.wall+1}: ${side}, ${z.w}√ó${z.h} cm</span><button class="del-btn" onclick="delZone(${z.id})">${t('del')}</button></div>`;
            });
            el.innerHTML = html;
        }
        
        function addWin() {
            const wall = parseInt(document.getElementById('winWall').value);
            const left = parseInt(document.getElementById('winLeft').value);
            const bottom = parseInt(document.getElementById('winBottom').value);
            const w = parseInt(document.getElementById('winW').value);
            const h = parseInt(document.getElementById('winH').value);
            if (!w || !h) return;
            windows.push({id:winCounter++, wall, left, bottom, w, h});
            updateWinList();
            drawAll();
        }
        
        function delWin(id) {
            windows = windows.filter(w => w.id !== id);
            updateWinList();
            drawAll();
        }
        
        function updateWinList() {
            const el = document.getElementById('winList');
            if (!windows.length) {
                el.innerHTML = `<div style="color:#666;font-style:italic;">${t('none')}</div>`;
                return;
            }
            let html = '';
            windows.forEach(w => {
                html += `<div class="item"><span>ü™ü ${t('wall')} ${w.wall+1}: ‚Üê${w.left} cm, ‚Üë${w.bottom} cm, ${w.w}√ó${w.h} cm</span><button class="del-btn" onclick="delWin(${w.id})">${t('del')}</button></div>`;
            });
            el.innerHTML = html;
        }
        
        function addTap() {
            const wall = parseInt(document.getElementById('tapWall').value);
            const x = parseInt(document.getElementById('tapX').value);
            const y = parseInt(document.getElementById('tapY').value);
            const d = parseInt(document.getElementById('tapD').value);
            if (!x || !y || !d) return;
            taps.push({id:tapCounter++, wall, x, y, d});
            updateTapList();
            drawAll();
        }
        
        function delTap(id) {
            taps = taps.filter(t => t.id !== id);
            updateTapList();
            drawAll();
        }
        
        function updateTapList() {
            const el = document.getElementById('tapList');
            if (!taps.length) {
                el.innerHTML = `<div style="color:#666;font-style:italic;">${t('none')}</div>`;
                return;
            }
            let html = '';
            taps.forEach(t => {
                html += `<div class="item"><span>üö∞ ${T[lang].wall} ${t.wall+1}: (${t.x}, ${t.y}) ‚åÄ${t.d} cm</span><button class="del-btn" onclick="delTap(${t.id})">${T[lang].del}</button></div>`;
            });
            el.innerHTML = html;
        }
        
        function saveData() {
            const data = {
                version: '2.0',
                date: new Date().toISOString(),
                tileW, tileH, verticalOffset,
                walls: walls.map(w => ({w:w.w, h:w.h, offsetX:w.offsetX})),
                zones: zones.map(z => ({wall:z.wall, side:z.side, w:z.w, h:z.h, color:z.color})),
                windows: windows.map(w => ({wall:w.wall, left:w.left, bottom:w.bottom, w:w.w, h:w.h})),
                taps: taps.map(t => ({wall:t.wall, x:t.x, y:t.y, d:t.d}))
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `carrelage-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert(t('save') + '!');
        }
        
        function loadData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    tileW = data.tileW || 60;
                    tileH = data.tileH || 60;
                    verticalOffset = data.verticalOffset || 0;
                    walls = data.walls.map(w => ({w:w.w, h:w.h, canvas:null, ctx:null, offsetX:w.offsetX||0}));
                    zones = data.zones.map((z,i) => ({id:i, wall:z.wall, side:z.side, w:z.w, h:z.h, color:z.color}));
                    zoneCounter = zones.length;
                    windows = data.windows.map((w,i) => ({id:i, wall:w.wall, left:w.left, bottom:w.bottom, w:w.w, h:w.h}));
                    winCounter = windows.length;
                    taps = data.taps.map((t,i) => ({id:i, wall:t.wall, x:t.x, y:t.y, d:t.d}));
                    tapCounter = taps.length;
                    document.getElementById('numWalls').value = walls.length;
                    document.getElementById('tileW').value = tileW;
                    document.getElementById('tileH').value = tileH;
                    updateWallInputs();
                    refreshSelects();
                    initCanvas();
                    updateZoneList();
                    updateWinList();
                    updateTapList();
                    alert(t('load') + '!');
                } catch (err) {
                    alert('Erreur: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }
        
        updateWallInputs();
        refreshSelects();
        initCanvas();
        updateZoneList();
        updateWinList();
        updateTapList();
    </script>
</body>
</html>
